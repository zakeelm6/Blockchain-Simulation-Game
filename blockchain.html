<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Blockchain Voting Challenge</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#9aa4b2;--accent:#6ee7b7;--danger:#ff7b7b}
    *{box-sizing:border-box;font-family:Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial}
    body{margin:0;background:linear-gradient(180deg,#071024 0%, #081226 60%);color:#e6eef6;min-height:100vh}
    .wrap{max-width:980px;margin:28px auto;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{font-size:20px;margin:0}
    .card{background:rgba(255,255,255,0.03);padding:16px;border-radius:10px;margin-bottom:12px;box-shadow:0 6px 18px rgba(2,6,23,0.6)}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type=text], input[type=number], select{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.02);color:inherit}
    button{background:var(--accent);border:none;padding:8px 12px;border-radius:8px;color:#042018;cursor:pointer}
    .btn-danger{background:var(--danger);color:#2b0a0a}
    .row{display:flex;gap:12px}
    .col{flex:1}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:10px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.03);font-size:14px}
    .muted{color:var(--muted);font-size:13px}
    .pill{display:inline-block;padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.03);font-weight:600}
    .small{font-size:13px}
    .controls{display:flex;gap:8px;align-items:center}
    .btn-outline{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--accent);padding:6px 10px;border-radius:8px}
    .hidden{display:none}
    footer{margin-top:20px;color:var(--muted);font-size:13px}
    .vote-row{display:flex;gap:8px;align-items:center}
    .vote-btn{flex:0 0 120px;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;cursor:pointer}
    .vote-for{background:rgba(110,231,183,0.08)}
    .vote-against{background:rgba(255,123,123,0.06)}
    .summary{display:flex;gap:12px;flex-wrap:wrap}
    .badge{background:rgba(255,255,255,0.03);padding:6px 10px;border-radius:8px}
    .nav{display:flex;gap:8px}
    .nav button{background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--muted);padding:6px 8px;border-radius:8px}
    .nav .active{color:var(--accent);border-color:rgba(110,231,183,0.18)}
    .notice{padding:10px;border-radius:8px;background:rgba(255,255,255,0.02);color:var(--muted);margin-bottom:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Blockchain Voting Challenge</h1>
      <div class="nav">
        <button id="nav-home" class="active">Home</button>
        <button id="nav-score">Scoreboard</button>
        <button id="nav-results">Final Results</button>
      </div>
    </header>

    <!-- HOME -->
    <section id="view-home" class="card">
      <div class="row">
        <div class="col">
          <label for="teamName">Team name</label>
          <input id="teamName" placeholder="e.g. Team Alpha" />
        </div>
        <div style="width:160px">
          <label for="teamScore">Initial score</label>
          <input id="teamScore" type="number" value="100" />
        </div>
      </div>
      <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
        <button id="addTeamBtn">Add team</button>
        <button id="clearBtn" class="btn-danger">Reset all data</button>
      </div>

      <div class="card" style="margin-top:12px">
        <h3 style="margin:0 0 6px 0">Teams</h3>
        <div id="teamsList" class="muted">No teams yet — add some above.</div>
      </div>

      <div style="margin-top:10px;display:flex;justify-content:flex-end">
        <button id="startChallenge">Start Challenge</button>
      </div>
    </section>

    <!-- SCOREBOARD -->
    <section id="view-scoreboard" class="card hidden">
      <h3 style="margin-top:0">Scoreboard</h3>
      <div id="scoreboardNotice" class="notice">Click <strong>Vote</strong> next to a team to record votes for that team's validator.</div>
      <table id="scoreboardTable">
        <thead><tr><th>Team</th><th>Score</th><th>For</th><th>Against</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- VOTE VIEW -->
    <section id="view-vote" class="card hidden">
      <h3 id="voterTitle">Voting</h3>
      <div id="voterNotice" class="notice"></div>
      <div id="voteList"></div>
      <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center">
        <div class="muted small">You can vote for OR against each other team.</div>
        <div style="display:flex;gap:8px">
          <button id="cancelVote" class="btn-outline">Cancel</button>
          <button id="submitVote">Submit votes</button>
        </div>
      </div>
    </section>

    <!-- RESULTS -->
    <section id="view-results" class="card hidden">
      <h3>Final Results</h3>
      <div id="finalSummary" class="muted small"></div>
      <table id="finalTable">
        <thead><tr><th>Rank</th><th>Team</th><th>Score</th><th>For</th><th>Against</th><th>Adjustments</th></tr></thead>
        <tbody></tbody>
      </table>
      <div style="margin-top:12px;display:flex;gap:8px">
        <button id="computeFinal">Compute Final Scores & Apply Bonuses</button>
        <button id="resetRound" class="btn-outline">Reset Votes Only</button>
      </div>
    </section>

  </div>

<script>
/*
 Data model stored in localStorage under key: "bc_challenge_teams"
 teams: [ { name, score, votesFor:0, votesAgainst:0, votersFor:[], votersAgainst:[], votedFor:[], votedAgainst:[] } ]
*/
const LS_KEY = 'bc_challenge_teams_v1';

// ------------------ helpers ------------------
function loadTeams(){
  try{ const raw = localStorage.getItem(LS_KEY); return raw ? JSON.parse(raw) : [] } catch(e){return []}
}
function saveTeams(teams){ localStorage.setItem(LS_KEY, JSON.stringify(teams)); }
function findTeam(name){ return loadTeams().find(t=>t.name === name) }
function renderTeamsList(){ const container = document.getElementById('teamsList'); const teams = loadTeams();
  if(!teams.length){ container.innerHTML = '<div class="muted">No teams yet — add some above.</div>'; return }
  let html = '<table style="width:100%"><thead><tr><th>Team</th><th>Score</th><th>Actions</th></tr></thead><tbody>';
  teams.forEach(t=>{ html += `<tr><td>${escapeHtml(t.name)}</td><td>${t.score}</td><td><button data-name="${escapeHtml(t.name)}" class="delBtn btn-outline">Delete</button></td></tr>` });
  html += '</tbody></table>';
  container.innerHTML = html;
  container.querySelectorAll('.delBtn').forEach(b=>b.addEventListener('click', e=>{ if(confirm('Delete team '+b.dataset.name+'?')){ deleteTeam(b.dataset.name) }}))
}
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])) }

function addTeam(name, score){ name = (name||'').trim(); score = Number(score)||0; if(!name) return alert('Enter a team name');
  const teams = loadTeams(); if(teams.some(t=>t.name.toLowerCase()===name.toLowerCase())) return alert('Team already exists');
  teams.push({ name, score, votesFor:0, votesAgainst:0, votersFor:[], votersAgainst:[], votedFor:[], votedAgainst:[] }); saveTeams(teams); renderTeamsList(); renderScoreboard(); }
function deleteTeam(name){ let teams = loadTeams(); teams = teams.filter(t=>t.name!==name); saveTeams(teams); renderTeamsList(); renderScoreboard(); }
function clearAll(){ if(!confirm('Reset ALL data? This cannot be undone.')) return; localStorage.removeItem(LS_KEY); renderAll(); }

// ------------------ NAV ------------------
function showView(id){ document.querySelectorAll('section').forEach(s=>s.classList.add('hidden')); document.getElementById(id).classList.remove('hidden');
  document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active'));
  if(id==='view-home') document.getElementById('nav-home').classList.add('active');
  if(id==='view-scoreboard') document.getElementById('nav-score').classList.add('active');
  if(id==='view-results') document.getElementById('nav-results').classList.add('active');
}

// ------------------ SCOREBOARD ------------------
function renderScoreboard(){ const tbody = document.querySelector('#scoreboardTable tbody'); const teams = loadTeams();
  if(!teams.length){ tbody.innerHTML = '<tr><td colspan="5" class="muted">No teams yet</td></tr>'; return }
  tbody.innerHTML = teams.map(t=>`<tr>
    <td>${escapeHtml(t.name)}</td>
    <td>${t.score}</td>
    <td>${t.votesFor||0}</td>
    <td>${t.votesAgainst||0}</td>
    <td><button class="voteAction" data-name="${escapeHtml(t.name)}">Vote</button></td>
  </tr>`).join('');
  document.querySelectorAll('.voteAction').forEach(b=>b.addEventListener('click', onStartVote));
}

let currentVoter = null; // name
let currentChoices = {}; // targetName -> 'for'|'against'|null

function onStartVote(e){ const validatorName = prompt('Validator team name (exact):'); if(!validatorName) return; const teams = loadTeams(); const voter = teams.find(t=>t.name===validatorName);
  if(!voter) { alert('Team not found. Make sure exact name matches.'); return }
  currentVoter = voter.name; currentChoices = {};
  showVoteViewFor(voter.name);
}

function showVoteViewFor(voterName){ showView('view-vote'); const teams = loadTeams().filter(t=>t.name!==voterName);
  document.getElementById('voterTitle').innerText = `Voting — ${voterName}`;
  document.getElementById('voterNotice').innerHTML = `<div class="muted small">Available points: <strong>${findTeam(voterName).score}</strong></div>`;
  const container = document.getElementById('voteList'); if(!teams.length){ container.innerHTML = '<div class="muted">No other teams to vote on.</div>'; return }
  let html = '<table style="width:100%"><thead><tr><th>Team</th><th>For</th><th>Against</th></tr></thead><tbody>';
  teams.forEach(t=>{ html += `<tr data-target="${escapeHtml(t.name)}"><td>${escapeHtml(t.name)}</td>
    <td><button class="vote-btn vote-for" data-target="${escapeHtml(t.name)}" data-choice="for">Vote For</button></td>
    <td><button class="vote-btn vote-against" data-target="${escapeHtml(t.name)}" data-choice="against">Vote Against</button></td>
  </tr>` });
  html += '</tbody></table>';
  container.innerHTML = html;
  container.querySelectorAll('.vote-btn').forEach(b=>b.addEventListener('click', onToggleChoice));
}

function onToggleChoice(e){ const btn = e.currentTarget; const target = btn.dataset.target; const choice = btn.dataset.choice; // toggle behavior: clicking same choice again removes
  const row = btn.closest('tr'); const other = row.querySelector(`[data-choice]`); // not reliable for multiple, we'll manage state
  const prev = currentChoices[target] || null;
  if(prev===choice) { delete currentChoices[target]; row.querySelectorAll('.vote-btn').forEach(x=>x.style.borderColor='rgba(255,255,255,0.04)'); row.querySelectorAll('.vote-btn').forEach(x=>x.style.opacity=1); return }
  currentChoices[target]=choice;
  // visual cue
  row.querySelectorAll('.vote-btn').forEach(x=>{ x.style.opacity = 0.35; x.style.borderColor='rgba(255,255,255,0.04)'; });
  btn.style.opacity = 1; btn.style.borderColor = 'rgba(110,231,183,0.5)';
}

function submitVotes(){ if(!currentVoter) return alert('No voter selected'); const teams = loadTeams(); const voter = teams.find(t=>t.name===currentVoter); const targets = Object.keys(currentChoices);
  // apply votes
  targets.forEach(targetName=>{
    const choice = currentChoices[targetName]; const target = teams.find(t=>t.name===targetName);
    if(!target) return;
    if(choice==='for'){ target.votesFor = (target.votesFor||0) + 1; target.votersFor = target.votersFor || []; if(!target.votersFor.includes(voter.name)) target.votersFor.push(voter.name);
      voter.votedFor = voter.votedFor || []; if(!voter.votedFor.includes(targetName)) voter.votedFor.push(targetName);
    } else if(choice==='against'){ target.votesAgainst = (target.votesAgainst||0) + 1; target.votersAgainst = target.votersAgainst || []; if(!target.votersAgainst.includes(voter.name)) target.votersAgainst.push(voter.name);
      voter.votedAgainst = voter.votedAgainst || []; if(!voter.votedAgainst.includes(targetName)) voter.votedAgainst.push(targetName);
    }
  });
  // deduct cost
  saveTeams(teams);
  currentVoter = null; currentChoices = {};
  renderScoreboard(); showView('view-scoreboard');
}

// ------------------ FINAL RESULTS ------------------
function renderFinalTable(teams, adjustments){ const tbody = document.querySelector('#finalTable tbody');
  tbody.innerHTML = teams.map((t,idx)=>`<tr>
    <td>${idx+1}</td>
    <td>${escapeHtml(t.name)}</td>
    <td>${t.score}</td>
    <td>${t.votesFor||0}</td>
    <td>${t.votesAgainst||0}</td>
    <td>${adjustments && adjustments[t.name] ? adjustments[t.name] : ''}</td>
  </tr>`).join('');
}

function computeFinal(){ const teams = loadTeams(); if(teams.length===0) return alert('No teams');
  // ranking by net votes (for - against); tie-breaker: more for, then higher score
  const snapshot = teams.map(t=>({ ...t }));
  snapshot.sort((a,b)=>{ const netA=(a.votesFor||0)-(a.votesAgainst||0); const netB=(b.votesFor||0)-(b.votesAgainst||0); if(netB!==netA) return netB-netA; if((b.votesFor||0)!=(a.votesFor||0)) return (b.votesFor||0)-(a.votesFor||0); return b.score - a.score; });
  const first = snapshot[0]; const last = snapshot[snapshot.length-1];
  const adjustments = {};
  // apply first and last adjustments to snapshot and original storage separately
  // First: +50 to first team, +30 to teams who voted for first
  if(first){ adjustments[first.name] = (adjustments[first.name]||0) + 50; }
  if(first && first.votersFor){ first.votersFor.forEach(vn=> adjustments[vn] = (adjustments[vn]||0) + 30); }
  // Last: -50 to last team, -30 to teams who voted for last
  if(last){ adjustments[last.name] = (adjustments[last.name]||0) - 50; }
  if(last && last.votersFor){ last.votersFor.forEach(vn=> adjustments[vn] = (adjustments[vn]||0) - 30); }

  // Apply adjustments to stored teams
  const store = loadTeams(); store.forEach(t=>{ const adj = adjustments[t.name]||0; t.score = Number(t.score||0) + adj; }); saveTeams(store);
  // re-render final table with updated scores
  const finalSnapshot = loadTeams().slice().sort((a,b)=>b.score - a.score);
  renderFinalTable(finalSnapshot, adjustments);
  alert('Final adjustments applied to scores. Final leaderboard updated.');
}

// reset votes only (keep teams and scores)
function resetVotes(){ if(!confirm('Reset only votes (keeps current scores)?')) return; const teams = loadTeams(); teams.forEach(t=>{ t.votesFor = 0; t.votesAgainst = 0; t.votersFor = []; t.votersAgainst = []; t.votedFor = []; t.votedAgainst = []; }); saveTeams(teams); renderAll(); }

// ------------------ UI wiring ------------------
document.getElementById('addTeamBtn').addEventListener('click', ()=>{ addTeam(document.getElementById('teamName').value, document.getElementById('teamScore').value); document.getElementById('teamName').value = ''; });
document.getElementById('clearBtn').addEventListener('click', clearAll);
document.getElementById('startChallenge').addEventListener('click', ()=>{ showView('view-scoreboard'); renderScoreboard(); });

document.getElementById('nav-home').addEventListener('click', ()=>showView('view-home'));
document.getElementById('nav-score').addEventListener('click', ()=>{ showView('view-scoreboard'); renderScoreboard(); });
document.getElementById('nav-results').addEventListener('click', ()=>{ showView('view-results'); renderFinalPlaceholder(); });

document.getElementById('cancelVote').addEventListener('click', ()=>{ currentVoter=null; currentChoices={}; showView('view-scoreboard'); });
document.getElementById('submitVote').addEventListener('click', submitVotes);

document.getElementById('computeFinal').addEventListener('click', computeFinal);
document.getElementById('resetRound').addEventListener('click', resetVotes);

function renderFinalPlaceholder(){ const teams = loadTeams(); if(!teams.length){ document.querySelector('#finalTable tbody').innerHTML = '<tr><td colspan="6" class="muted">No teams</td></tr>'; document.getElementById('finalSummary').innerText=''; return }
  const snapshot = teams.slice().sort((a,b)=>{ return ( (b.votesFor||0)-(b.votesAgainst||0) ) - ( (a.votesFor||0)-(a.votesAgainst||0) ); });
  document.getElementById('finalSummary').innerText = `Current net-vote ranking (by for - against). First will get +50; voters who supported first get +30. Last will get -50; voters who supported last lose -30.`;
  renderFinalTable(snapshot, null);
}

function renderAll(){ renderTeamsList(); renderScoreboard(); renderFinalPlaceholder(); }

// export/import helper (for advanced use via console)
function exportTeams(){ return JSON.stringify(loadTeams(), null, 2); }
function importTeams(json){ try{ const arr = JSON.parse(json); if(!Array.isArray(arr)) throw 'expected array'; saveTeams(arr); renderAll(); alert('Imported'); }catch(e){ alert('Import failed: '+e) } }

// initial
renderAll();
showView('view-home');

// expose debug helpers
window.exportTeams = exportTeams; window.importTeams = importTeams; window.clearAll = clearAll;
</script>
</body>
</html>


